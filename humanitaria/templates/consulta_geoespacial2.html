{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% block content %}
{% load leaflet_tags %}
{% leaflet_js plugins="forms, minimap" %}
{% leaflet_css plugins="forms, minimap" %}
 <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'humanitaria/css/Control.FullScreen.css' %}" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<link rel="stylesheet" href="
{% static 'humanitaria/css/Control.Loading.css' %}" />
<script src="{% static 'humanitaria/js/Control.Loading.js' %}"></script>

<link rel="stylesheet" href="{% static 'humanitaria/css/leaflet-sidebar.min.css' %}" />
<script src="{% static 'humanitaria/js/leaflet-sidebar.min.js' %}"></script>

<link rel="stylesheet" href="{% static 'humanitaria/css/leaflet-search.css' %}"/>
<script src="{% static 'humanitaria/js/leaflet-search.js' %}"></script>
    <link rel="stylesheet" href="{% static 'humanitaria/css/styles.css' %}"/>
{{ form.media.css }}
{{ form.media.js }}

    <div id="sidebar" class="leaflet-sidebar collapsed">
    <!-- Nav tabs -->
    <div class="leaflet-sidebar-tabs">
        <ul role="tablist"> <!-- top aligned tabs -->
            <li><a href="#home" role="tab"><i class="fa fa-globe"></i></a></li>
            <li><a href="#profile" role="tab"><i class="fa fa-map-pin"></i></a></li>
        </ul>

    </div>


    <div class="leaflet-sidebar-content">
        <div class="leaflet-sidebar-pane" id="home">
            <h1 class="leaflet-sidebar-header">
                Consulta geoespacial
                <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
            </h1>
            <form method="post" action="
{% url 'humanitaria:consulta_geoespacial' %}">
                {% csrf_token %}
                {% crispy form_geo %}
            </form>
        </div>
    </div>
</div>

    {% if geojson %}
    <script>
        var e = {{ entidad|safe }};
        var m = {{ municipio|safe }};
        var l = {{ localidad|safe }};
        var a = {{ agebu|safe }};
        var ar = {{ agebr|safe }};
        var mza = {{ manzana|safe }};
    </script>
{% else %}
    <script>
        var e = null;
        var m = null;
        var l = null;
        var a = null;
        var ar = null;
        var mza = null;
    </script>
{% endif %}

    <script type="text/javascript">
    $(function() {
        $('.django-select2').djangoSelect2({dropdownParent: $('#sidebar')});
    });

    function map_init_basic (map, options) {

        var HERE_hybridDay = L.tileLayer('https://{s}.{base}.maps.cit.api.here.com/maptile/2.1/{type}/{mapID}/hybrid.day/{z}/{x}/{y}/{size}/{format}?app_id={app_id}&app_code={app_code}&lg={language}', {
            attribution: 'Map &copy; 1987-2014 <a href="http://developer.here.com">HERE</a>',
            subdomains: '1234',
            mapID: 'newest',
            app_id: 'ODO3XU8gNqMe0wMRFTx3',
            app_code: 'rA-Pn3rOrBPniz565TRJ6A',
            base: 'aerial',
            maxZoom: 20,
            type: 'maptile',
            language: 'spa',
            format: 'png8',
            size: '256',
            ppi: 500

        });

        HERE_hybridDay.addTo(map);

        // new L.Control.ResetView([19.419444,  -99.145556]).addTo(map);
        var sidebar = L.control.sidebar({
            autopan: false,       // whether to maintain the centered map point when opening the sidebar
            closeButton: true,    // whether t add a close button to the panes
            container: 'sidebar', // the DOM container or #ID of a predefined sidebar container that should be used
            position: 'left'     // left or right
        }).addTo(map);

        var loadingControl = L.Control.loading();

        map.addControl(loadingControl);

        L.control.fullscreen({
            position: 'topleft', // change the position of the button can be topleft, topright, bottomright or bottomleft, defaut topleft
            title: 'Pantalla completa', // change the title of the button, default Full Screen
            titleCancel: 'Salir de pantalla completa', // change the title of the button when fullscreen is on, default Exit Full Screen
            fullscreenElement: false // Dom element to render in full screen, false by default, fallback to map._container
        }).addTo(map);

        var ent = new L.geoJson(e, {
            onEachFeature: function(feature,layer){
                var props = feature.properties;
                var content = props.contenido;
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
                layer.bindPopup(content);
            },
            style: style
        });

        var mun = new L.geoJson(m, {
            onEachFeature: function(feature,layer){
                var props = feature.properties;
                var content = props.contenido;
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
                layer.bindPopup(content);
            },
            style: style
        });

        var loc = new L.geoJson(l, {
            onEachFeature: function(feature,layer){
                var props = feature.properties;
                var content = props.contenido;
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
                layer.bindPopup(content);
            },
            style: style
        });


        var overlays = {
            "Áreas de búsqueda": ent,
            "Municipio": mun,
            "Localidades": loc,
            "Capa satelital": HERE_hybridDay
        };


        if (ent._layers) {
            ent.addTo(map);
        }

        if (mun._layers) {
            mun.addTo(map);
        }

        if (loc._layers) {
            loc.addTo(map);
        }


        L.control.layers(null, overlays).addTo(map);

        var controlSearch = new L.Control.Search({
            position:'topright',
            layer: ent,
            propertyName: 'nomgeo',
            textErr: 'No existe',
            textPlaceholder: 'Buscar municipio',
            hideMarkerOnCollapse: true,
            marker: {
                circle: {
                    radius: 20,
                    color: '#00e3ff',
                    opacity: 1
                }
            }
        });

        map.addControl(controlSearch);

        function getColor(d) {
            return d > 35 ? '#800026' :
                d > 30  ? '#BD0026' :
                    d > 25  ? '#E31A1C' :
                        d > 20  ? '#FC4E2A' :
                            d > 15   ? '#FD8D3C' :
                                d > 10   ? '#FEB24C' :
                                    d > 5   ? '#FED976' :
                                        '#FFEDA0';
        }

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.numero_dengues),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        function highlightFeature(e) {
            var layer = e.target;

            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            });

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            ent.resetStyle(e.target);

            info.update();
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 5, 10, 15, 20, 25, 30, 35],
                labels = [];
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            return div;
        };

        legend.addTo(map);



        var info = L.control({position: 'bottomleft'});

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        info.update = function (props) {
            if (props) {
                var nombre = null;
                if (props.nomloc) {
                    nombre = props.nomloc
                }
                else {
                    nombre = props.nomgeo
                }
                this._div.innerHTML = '<h4>Casos de Dengue por área</h4>' +  (props ?
                    '<b>' + 'Nombre:' + nombre + '</b><br />' + 'Número de casos:' + props.numero_dengues
                    : 'Coloca el puntero sobre un área');
            }
        };

        info.addTo(map);
    }
</script>

{% leaflet_map "gis" callback="window.map_init_basic" %}
{% endblock %}